<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ ê°ì§€ ë°ëª¨</title>

    <!-- ë Œë” ë¸”ë¡œí‚¹ CSS -->
    <link rel="stylesheet" href="styles/blocking.css" />

    <!-- ë¹„ë Œë” ë¸”ë¡œí‚¹ CSS (media="print") -->
    <link rel="stylesheet" href="styles/print.css" media="print" />

    <!-- ë Œë” ë¸”ë¡œí‚¹ ìë°”ìŠ¤í¬ë¦½íŠ¸ (ë™ê¸°) -->
    <script src="scripts/blocking.js"></script>

    <!-- ë¹„ë Œë” ë¸”ë¡œí‚¹ ìë°”ìŠ¤í¬ë¦½íŠ¸ (async) -->
    <script src="scripts/async.js" async></script>

    <!-- ë¹„ë Œë” ë¸”ë¡œí‚¹ ìë°”ìŠ¤í¬ë¦½íŠ¸ (defer) -->
    <script src="scripts/defer.js" defer></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        background: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        margin-bottom: 1rem;
      }

      .description {
        color: #666;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f9f9f9;
        border-left: 4px solid #007bff;
        border-radius: 4px;
      }

      .controls {
        margin-bottom: 2rem;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #0056b3;
      }

      button:active {
        transform: translateY(1px);
      }

      .results {
        margin-top: 2rem;
      }

      .section {
        margin-bottom: 2rem;
      }

      .section h2 {
        color: #333;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #007bff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        background: white;
      }

      th,
      td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .badge-blocking {
        background: #dc3545;
        color: white;
      }

      .badge-non-blocking {
        background: #28a745;
        color: white;
      }

      .badge-css {
        background: #007bff;
        color: white;
      }

      .badge-js {
        background: #ffc107;
        color: #333;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .stat-card {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }

      .stat-card h3 {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
      }

      .code-block {
        background: #f4f4f4;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        margin-top: 1rem;
      }

      .code-block pre {
        margin: 0;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.875rem;
      }

      .timeline {
        margin-top: 1rem;
        padding: 1rem;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .timeline-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 4px;
        border-left: 3px solid #007bff;
      }

      .url {
        color: #007bff;
        word-break: break-all;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ ê°ì§€ ë°ëª¨</h1>

      <div class="description">
        <strong>ì´ í˜ì´ì§€ëŠ” ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤:</strong>
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem">
          <li>ë Œë” ë¸”ë¡œí‚¹ CSS (blocking.css)</li>
          <li>ë¹„ë Œë” ë¸”ë¡œí‚¹ CSS (print.css with media="print")</li>
          <li>ë Œë” ë¸”ë¡œí‚¹ ìë°”ìŠ¤í¬ë¦½íŠ¸ (blocking.js, ë™ê¸°)</li>
          <li>ë¹„ë Œë” ë¸”ë¡œí‚¹ ìë°”ìŠ¤í¬ë¦½íŠ¸ (async.js, defer.js)</li>
        </ul>
        <p style="margin-top: 0.5rem">
          ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ë¥¼ ë¶„ì„í•˜ì„¸ìš”.
        </p>
      </div>

      <div class="controls">
        <button onclick="analyzeRenderBlockingResources()">
          ğŸ“Š ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ ë¶„ì„
        </button>
      </div>

      <div class="results" id="results"></div>
    </div>

    <script>
      // ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ ë¶„ì„ í•¨ìˆ˜
      function analyzeRenderBlockingResources() {
        const renderBlockingResources = []
        const nonBlockingResources = []

        // CSS í™•ì¸
        document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
          const isBlocking =
            !link.media || link.media === 'all' || link.media === 'screen'

          const resource = {
            type: 'CSS',
            url: link.href,
            media: link.media || 'all',
            isBlocking,
          }

          if (isBlocking) {
            renderBlockingResources.push(resource)
          } else {
            nonBlockingResources.push(resource)
          }
        })

        // ìë°”ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
        document.querySelectorAll('script[src]').forEach((script) => {
          const inHead = script.closest('head') !== null
          const isBlocking = !script.async && !script.defer && inHead

          const resource = {
            type: 'JavaScript',
            url: script.src,
            async: script.async,
            defer: script.defer,
            location: inHead ? 'head' : 'body',
            isBlocking,
          }

          if (isBlocking) {
            renderBlockingResources.push(resource)
          } else {
            nonBlockingResources.push(resource)
          }
        })

        // Performance APIë¡œ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const perfResources = performance.getEntriesByType('resource')
        renderBlockingResources.forEach((resource) => {
          const perfEntry = perfResources.find((p) => p.name === resource.url)
          if (perfEntry) {
            resource.duration = perfEntry.duration.toFixed(2)
            resource.size = perfEntry.transferSize
            resource.startTime = perfEntry.startTime.toFixed(2)
          }
        })

        nonBlockingResources.forEach((resource) => {
          const perfEntry = perfResources.find((p) => p.name === resource.url)
          if (perfEntry) {
            resource.duration = perfEntry.duration.toFixed(2)
            resource.size = perfEntry.transferSize
            resource.startTime = perfEntry.startTime.toFixed(2)
          }
        })

        // ê²°ê³¼ ì¶œë ¥
        displayResults(renderBlockingResources, nonBlockingResources)

        // ì½˜ì†”ì—ë„ ì¶œë ¥
        console.log('ğŸ”´ Render Blocking Resources:')
        console.table(renderBlockingResources)
        console.log('ğŸŸ¢ Non-Blocking Resources:')
        console.table(nonBlockingResources)
      }

      // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
      function displayResults(blockingResources, nonBlockingResources) {
        const resultsDiv = document.getElementById('results')

        // í†µê³„
        const totalBlocking = blockingResources.length
        const totalNonBlocking = nonBlockingResources.length
        const totalSize = blockingResources.reduce(
          (sum, r) => sum + (r.size || 0),
          0,
        )
        const totalDuration = blockingResources.reduce(
          (sum, r) => sum + (parseFloat(r.duration) || 0),
          0,
        )

        resultsDiv.innerHTML = `
          <div class="section">
            <h2>ğŸ“ˆ í†µê³„</h2>
            <div class="stats">
              <div class="stat-card">
                <h3>ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤</h3>
                <div class="value">${totalBlocking}</div>
              </div>
              <div class="stat-card">
                <h3>ë¹„ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤</h3>
                <div class="value">${totalNonBlocking}</div>
              </div>
              <div class="stat-card">
                <h3>ì´ í¬ê¸° (ë¸”ë¡œí‚¹)</h3>
                <div class="value">${(totalSize / 1024).toFixed(1)} KB</div>
              </div>
              <div class="stat-card">
                <h3>ì´ ë¡œë”© ì‹œê°„</h3>
                <div class="value">${totalDuration.toFixed(0)} ms</div>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>ğŸ”´ ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ (${totalBlocking}ê°œ)</h2>
            ${blockingResources.length > 0 ? generateTable(blockingResources) : '<p>ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
          </div>

          <div class="section">
            <h2>ğŸŸ¢ ë¹„ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ (${totalNonBlocking}ê°œ)</h2>
            ${nonBlockingResources.length > 0 ? generateTable(nonBlockingResources) : '<p>ë¹„ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
          </div>

          <div class="section">
            <h2>ğŸ’¡ ê°œì„  ì œì•ˆ</h2>
            ${generateRecommendations(blockingResources)}
          </div>

          <div class="section">
            <h2>ğŸ“‹ ê°ì§€ ì½”ë“œ</h2>
            <div class="code-block">
              <pre>${getDetectionCode()}</pre>
            </div>
          </div>
        `
      }

      // í…Œì´ë¸” ìƒì„±
      function generateTable(resources) {
        const rows = resources
          .map((resource) => {
            const typeBadge =
              resource.type === 'CSS'
                ? '<span class="badge badge-css">CSS</span>'
                : '<span class="badge badge-js">JS</span>'
            const blockingBadge = resource.isBlocking
              ? '<span class="badge badge-blocking">Blocking</span>'
              : '<span class="badge badge-non-blocking">Non-Blocking</span>'

            let details = ''
            if (resource.type === 'CSS') {
              details = `media="${resource.media}"`
            } else {
              details = `async=${resource.async}, defer=${resource.defer}`
            }

            return `
              <tr>
                <td>${typeBadge}</td>
                <td>${blockingBadge}</td>
                <td><div class="url">${getFileName(resource.url)}</div></td>
                <td>${details}</td>
                <td>${resource.duration || '-'} ms</td>
                <td>${resource.size ? (resource.size / 1024).toFixed(2) : '-'} KB</td>
              </tr>
            `
          })
          .join('')

        return `
          <table>
            <thead>
              <tr>
                <th>íƒ€ì…</th>
                <th>ìƒíƒœ</th>
                <th>URL</th>
                <th>ì†ì„±</th>
                <th>ë¡œë”© ì‹œê°„</th>
                <th>í¬ê¸°</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `
      }

      // ê°œì„  ì œì•ˆ ìƒì„±
      function generateRecommendations(blockingResources) {
        const recommendations = []

        blockingResources.forEach((resource) => {
          if (resource.type === 'CSS') {
            recommendations.push(`
              <div class="timeline-item">
                <strong>CSS ìµœì í™”:</strong> ${getFileName(resource.url)}<br>
                <span style="color: #666; font-size: 0.875rem;">
                  âœ… Critical CSSë¥¼ ì¸ë¼ì¸ìœ¼ë¡œ ì‚½ì…í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë¹„ë™ê¸° ë¡œë“œ<br>
                  âœ… 14KB ì´í•˜ë¡œ ìœ ì§€í•˜ì—¬ ì²« RTTì— í¬í•¨
                </span>
              </div>
            `)
          } else if (resource.type === 'JavaScript') {
            recommendations.push(`
              <div class="timeline-item">
                <strong>JavaScript ìµœì í™”:</strong> ${getFileName(resource.url)}<br>
                <span style="color: #666; font-size: 0.875rem;">
                  âœ… async ë˜ëŠ” defer ì†ì„± ì¶”ê°€<br>
                  âœ… í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ë§Œ headì— ë°°ì¹˜, ë‚˜ë¨¸ì§€ëŠ” body ëì— ì´ë™
                </span>
              </div>
            `)
          }
        })

        if (recommendations.length === 0) {
          return '<p style="color: #28a745; font-weight: 600;">âœ… ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìµœì í™”ê°€ ì˜ ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</p>'
        }

        return `<div class="timeline">${recommendations.join('')}</div>`
      }

      // íŒŒì¼ëª… ì¶”ì¶œ
      function getFileName(url) {
        try {
          return new URL(url).pathname.split('/').pop() || url
        } catch {
          return url
        }
      }

      // ê°ì§€ ì½”ë“œ ë¬¸ìì—´
      function getDetectionCode() {
        return `// ë Œë” ë¸”ë¡œí‚¹ ë¦¬ì†ŒìŠ¤ ê°ì§€ ì½”ë“œ
const renderBlockingResources = []

// CSS í™•ì¸
document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
  if (!link.media || link.media === 'all' || link.media === 'screen') {
    renderBlockingResources.push({
      type: 'CSS',
      url: link.href,
      size: null, // Performance APIë¡œ í™•ì¸ ê°€ëŠ¥
    })
  }
})

// ë™ê¸° ìŠ¤í¬ë¦½íŠ¸ í™•ì¸ (head ë‚´ë¶€, async/defer ì—†ìŒ)
document.querySelectorAll('script[src]').forEach((script) => {
  const inHead = script.closest('head') !== null
  const isBlocking = !script.async && !script.defer && inHead

  if (isBlocking) {
    renderBlockingResources.push({
      type: 'JavaScript',
      url: script.src,
      async: false,
      defer: false,
    })
  }
})

console.table(renderBlockingResources)`
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¶„ì„ (ì„ íƒì )
      // window.addEventListener('load', () => {
      //   setTimeout(analyzeRenderBlockingResources, 1000)
      // })
    </script>
  </body>
</html>
